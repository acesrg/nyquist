variables:
  PEP8_CONFIG_FILE: .flake8

stages:
  - lint
  - docs
  - deploy

flake8:
  stage: lint
  image: registry.gitlab.com/pipeline-components/flake8:latest
  script:
    - flake8 --verbose --config $PEP8_CONFIG_FILE .

pages:
  stage: docs
  image: sphinxdoc/sphinx
  script:
    - cd docs
    - make html
    - mkdir $CI_PROJECT_DIR/public
    - mv $CI_PROJECT_DIR/docs/build/html/* $CI_PROJECT_DIR/public
  artifacts:
    paths:
      - $CI_PROJECT_DIR/public/*
    expire_in: 1 day
  rules:
    - if: '$BUILD_THE_DOCS'
    - if: '$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^docs/'
    - if: '$CI_COMMIT_BRANCH == "master"'

pypi-deploy:
  stage: deploy
  image: python:3.8.7-buster
  variables:
    CRYPTOGRAPHY_DONT_BUILD_RUST: 1
  before_script:
    - pip install twine -q
    - python3 setup.py sdist
  script:
    - twine upload -u=__token__ -p=$PYPI_UPLOAD_TOKEN dist/*
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+.\d+.\d+/'
  tags:
    - local 
